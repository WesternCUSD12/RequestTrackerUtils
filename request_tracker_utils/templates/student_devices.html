{% extends 'base.html' %}

{% block title %}Student Device Check-in List{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Breadcrumb Navigation -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/devices">Devices</a></li>
      <li class="breadcrumb-item active" aria-current="page">Student Device List</li>
    </ol>
  </nav>

  <div class="row mb-4">
    <div class="col-12">
      <h1 class="mb-3">Student Device Tracking</h1>
      <p class="lead">Track device check-ins by grade for the {{ current_year }} school year.</p>
    </div>
  </div>

  <!-- Dashboard Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body">
          <h5 class="card-title">Total Students</h5>
          <h2 class="display-4" id="stat-total-students">{{ stats.total_students }}</h2>
          <p class="card-text small" id="stat-total-label">All students</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body">
          <h5 class="card-title">Checked In</h5>
          <h2 class="display-4" id="stat-checked-in">{{ stats.checked_in }}</h2>
          <p class="card-text small" id="stat-checked-label">All students</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card bg-warning text-dark h-100">
        <div class="card-body">
          <h5 class="card-title">Pending</h5>
          <h2 class="display-4" id="stat-not-checked-in">{{ stats.not_checked_in }}</h2>
          <p class="card-text small" id="stat-pending-label">All students</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body">
          <h5 class="card-title">Completion Rate</h5>
          <h2 class="display-4" id="stat-completion-rate">{{ "%.1f"|format(stats.completion_rate) }}%</h2>
          <p class="card-text small" id="stat-rate-label">All students</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body d-flex justify-content-between">
          <div>
            <button id="refreshStudentsBtn" class="btn btn-outline-primary me-2">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button id="checkRtAssignmentsBtn" class="btn btn-outline-info me-2">
              <i class="bi bi-check-circle"></i> Check RT Assignments
            </button>
            <a href="{{ url_for('students.student_import') }}" class="btn btn-outline-success me-2">
              <i class="bi bi-file-earmark-arrow-up"></i> Import Students
            </a>
            <a href="{{ url_for('students.student_export') }}" class="btn btn-outline-secondary me-2">
              <i class="bi bi-file-earmark-arrow-down"></i> Export CSV
            </a>
            <button id="clearAllStudentsBtn" class="btn btn-outline-danger me-2">
              <i class="bi bi-trash"></i> Clear All Students
            </button>
          </div>
          <div>
            <button id="addStudentBtn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
              <i class="bi bi-person-plus"></i> Add Student
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Student Filtering Controls -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Filter Students</h5>
        </div>
        <div class="card-body">
          <!-- Filter form -->
          <form id="filterForm" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Grade Levels</label>
              <div id="gradeCheckboxes" class="d-flex flex-wrap gap-2">
                {% for grade in ['6', '7', '8', '9', '10', '11', '12'] %}
                <div class="form-check form-check-inline">
                  <input class="form-check-input grade-filter" type="checkbox" value="{{ grade }}" id="grade{{ grade }}">
                  <label class="form-check-label" for="grade{{ grade }}">
                    Grade {{ grade }}
                  </label>
                </div>
                {% endfor %}
                <!-- Grade quick selection buttons -->
                <div class="ms-3">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllGrades">Select All</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllGrades">Clear</button>
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <label for="statusFilter" class="form-label">Check-in Status</label>
              <select class="form-select" id="statusFilter">
                <option value="all" selected>All Statuses</option>
                <option value="checked_in">Checked In</option>
                <option value="not_checked_in">Not Checked In</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label for="searchInput" class="form-label">Search Students</label>
              <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Name or ID...">
                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Student List with Loading State -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">Student Device List</h2>
      <span id="studentCount" class="badge bg-light text-dark">0 students</span>
    </div>
    <div class="card-body p-0">
      <!-- Loading indicator -->
      <div id="loadingIndicator" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading student data...</p>
      </div>
      
      <!-- Student table (initially hidden) -->
      <div id="studentTableContainer" class="table-responsive" style="display: none;">
        <table class="table table-striped table-hover mb-0" id="studentTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Grade</th>
              <th>Check-in Status</th>
              <th>Device Info</th>
              <th>Check-in Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="studentTableBody">
            <!-- Student rows will be inserted here by JavaScript -->
          </tbody>
          <tfoot id="studentTableFooter" class="border-top">
            <!-- Footer content (like RT data loading button) will be inserted here -->
          </tfoot>
        </table>
      </div>
      
      <!-- No results message (initially hidden) -->
      <div id="noResultsMessage" class="alert alert-info m-3" style="display: none;">
        <i class="bi bi-info-circle me-2"></i>
        No students match your current filters.
      </div>
    </div>
  </div>
  
  <!-- View Student Modal -->
  <div class="modal fade" id="viewStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewStudentTitle">Student Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">
                  <h5>Student Information</h5>
                </div>
                <div class="card-body">
                  <ul class="list-group list-group-flush" id="studentDetails">
                    <!-- Student details populated by JavaScript -->
                  </ul>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">
                  <h5>Device Information</h5>
                </div>
                <div class="card-body" id="deviceInfo">
                  <!-- Device info populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h5>RT Device Information</h5>
            </div>
            <div class="card-body" id="rtDeviceLookup">
              <!-- RT device lookup populated by JavaScript -->
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <p class="mb-2 text-muted">Lookup devices assigned to this student in RT</p>
                </div>
                <button class="btn btn-outline-primary" id="lookupRTDevicesBtn">
                  <i class="bi bi-search"></i> Lookup RT Devices
                </button>
              </div>
              
              <!-- Placeholder for RT devices display -->
              <div id="rtDevicesContainer" class="mt-3" style="display: none;">
                <h6 class="border-bottom pb-2">Assigned Devices in RT</h6>
                <div id="rtDevicesList">
                  <!-- RT Devices populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" id="checkInDeviceBtn" style="display: none;">
            <i class="bi bi-box-arrow-in-down"></i> Check In Device
          </button>
          <button type="button" class="btn btn-warning" id="checkOutDeviceBtn" style="display: none;">
            <i class="bi bi-box-arrow-up"></i> Check Out Device
          </button>
          <button type="button" class="btn btn-success" id="checkInAllDevicesBtn" style="display: none;">
            <i class="bi bi-check-all"></i> Check In All Devices
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Student Modal -->
  <div class="modal fade" id="addStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addStudentForm">
            <div class="mb-3">
              <label for="studentId" class="form-label">Student ID</label>
              <input type="text" class="form-control" id="studentId" required>
            </div>
            <div class="mb-3">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="firstName" required>
            </div>
            <div class="mb-3">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="lastName" required>
            </div>
            <div class="mb-3">
              <label for="grade" class="form-label">Grade</label>
              <select class="form-select" id="grade">
                <option value="6">6th Grade</option>
                <option value="7">7th Grade</option>
                <option value="8">8th Grade</option>
                <option value="9">9th Grade</option>
                <option value="10">10th Grade</option>
                <option value="11">11th Grade</option>
                <option value="12">12th Grade</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="rtUserId" class="form-label">RT User ID (optional)</label>
              <input type="text" class="form-control" id="rtUserId">
              <div class="form-text">The Request Tracker user ID for device lookup</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveStudentBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Ticket Modal -->
  <div class="modal fade" id="createTicketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create RT Ticket</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createTicketForm">
            <div class="mb-3">
              <label for="ticketSubject" class="form-label">Subject</label>
              <input type="text" class="form-control" id="ticketSubject" required>
            </div>
            <div class="mb-3">
              <label for="ticketQueue" class="form-label">Queue</label>
              <select class="form-select" id="ticketQueue">
                <option value="General">General</option>
                <option value="IT">IT</option>
                <option value="Repairs">Repairs</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="ticketContent" class="form-label">Description</label>
              <textarea class="form-control" id="ticketContent" rows="5" required></textarea>
            </div>
            <!-- Hidden fields for device/student info -->
            <input type="hidden" id="ticketDeviceId">
            <input type="hidden" id="ticketDeviceName">
            <input type="hidden" id="ticketStudentId">
          </form>
          <div id="ticketSuccessMessage" class="alert alert-success mt-3" style="display: none;">
            <i class="bi bi-check-circle me-2"></i>
            Ticket created successfully! <span id="ticketNumber"></span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitTicketBtn">Create Ticket</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Clear All Students Confirmation Modal -->
  <div class="modal fade" id="clearAllStudentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Clear All Students</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Warning:</strong> This action will permanently delete all students from the database and cannot be undone.
          </div>
          <p>Are you sure you want to clear all students?</p>
          <p>Total students: <strong id="clearStudentCount">0</strong></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmClearStudentsBtn">
            <i class="bi bi-trash"></i> Clear All Students
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Messages -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-success text-white">
      <i class="bi bi-check-circle me-2"></i>
      <strong class="me-auto">Success</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="successToastMessage">
      Operation completed successfully.
    </div>
  </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-danger text-white">
      <i class="bi bi-exclamation-circle me-2"></i>
      <strong class="me-auto">Error</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="errorToastMessage">
      An error occurred.
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set the server API port from Flask config
const API_PORT = {{ api_port }};

// Log the port at start
console.log('Student Devices: Using API_PORT:', API_PORT);

// Helper function to build API URLs correctly based on environment
function buildApiUrl(endpoint) {
  // Ensure endpoint starts with a slash
  if (!endpoint.startsWith('/')) {
    endpoint = '/' + endpoint;
  }
  
  const origin = window.location.origin;
  const hostname = window.location.hostname;
  const port = window.location.port;
  
  let url;
  
  if (port === '5000') {
    url = `http://localhost:${API_PORT}${endpoint}`;
    // console.log(`[buildApiUrl] Dev server detected (port=${port}), routing to API port ${API_PORT}: ${url}`);
  } else {
    url = `${origin}${endpoint}`;
    // console.log(`[buildApiUrl] Production mode (port=${port}), using same origin: ${url}`);
  }
  
  return url;
}

// Helper function to escape HTML special characters
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') {
        if (unsafe === null || typeof unsafe === 'undefined') return '';
        try {
            unsafe = String(unsafe);
        } catch (e) {
            return ''; // Or handle error appropriately
        }
    }
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}


document.addEventListener('DOMContentLoaded', function() {
  // Initialize variables
  let currentStudentId = null;
  // let studentData = null; // studentData seems unused, replaced by allStudents
  // let rtDevices = null; // rtDevices seems unused globally
  let allStudents = [];
  
  // Initialize Bootstrap components
  const successToast = new bootstrap.Toast(document.getElementById('successToast'));
  const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));
  const addStudentModal = new bootstrap.Modal(document.getElementById('addStudentModal'));
  const viewStudentModal = new bootstrap.Modal(document.getElementById('viewStudentModal'));
  const clearAllStudentsModal = new bootstrap.Modal(document.getElementById('clearAllStudentsModal'));
  const createTicketModal = new bootstrap.Modal(document.getElementById('createTicketModal'));
  
  // DOM elements
  const loadingIndicator = document.getElementById('loadingIndicator');
  const studentTableContainer = document.getElementById('studentTableContainer');
  const studentTableBody = document.getElementById('studentTableBody');
  const noResultsMessage = document.getElementById('noResultsMessage');
  const studentCount = document.getElementById('studentCount');
  const studentTableFooter = document.getElementById('studentTableFooter');
  
  // Grade filter checkboxes
  const gradeCheckboxes = document.querySelectorAll('.grade-filter');
  const selectAllGradesBtn = document.getElementById('selectAllGrades');
  const clearAllGradesBtn = document.getElementById('clearAllGrades');
  
  // Status filter
  const statusFilter = document.getElementById('statusFilter');
  
  // Search input
  const searchInput = document.getElementById('searchInput');
  const clearSearchBtn = document.getElementById('clearSearch');
  
  console.log('Starting to load student data...');
  loadStudents();
  
  // Add event listeners for filter controls
  gradeCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', filterStudents);
  });
  
  selectAllGradesBtn.addEventListener('click', function() {
    gradeCheckboxes.forEach(checkbox => checkbox.checked = true);
    filterStudents();
  });

  clearAllGradesBtn.addEventListener('click', function() {
    gradeCheckboxes.forEach(checkbox => checkbox.checked = false);
    filterStudents();
  });

  statusFilter.addEventListener('change', filterStudents);
  searchInput.addEventListener('input', filterStudents);

  clearSearchBtn.addEventListener('click', function() {
    searchInput.value = '';
    filterStudents();
  });

  // Event listener for refresh button
  document.getElementById('refreshStudentsBtn').addEventListener('click', function() {
    showToast('Refreshing student data...', 'info'); // Using a generic toast for info
    loadStudents();
  });
  
  // Event listener for "Check RT Assignments" button
  document.getElementById('checkRtAssignmentsBtn').addEventListener('click', function() {
    showToast('Checking all RT assignments. This may take a moment.', 'info');
    // Force re-check for all students, even if loaded.
    allStudents.forEach(student => {
        if (student.rt_user_id) {
            student.rt_devices_loaded = false; 
            student.rt_load_error = false;
            // student.rt_devices_loading is handled by loadRTDevicesForVisibleStudents
        }
    });
    loadRTDevicesForVisibleStudents();
  });

  // Add Student Modal Logic
  document.getElementById('saveStudentBtn').addEventListener('click', function() {
    const studentId = document.getElementById('studentId').value;
    const firstName = document.getElementById('firstName').value;
    const lastName = document.getElementById('lastName').value;
    const grade = document.getElementById('grade').value;
    const rtUserId = document.getElementById('rtUserId').value;

    if (!studentId || !firstName || !lastName || !grade) {
      showErrorToast('Please fill in all required fields.');
      return;
    }

    const studentPayload = {
      id: studentId,
      first_name: firstName,
      last_name: lastName,
      grade: grade,
      rt_user_id: rtUserId || null 
    };

    fetch(buildApiUrl('/students'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(studentPayload)
    })
    .then(response => response.json().then(data => ({ ok: response.ok, data })))
    .then(({ ok, data }) => {
      if (ok) {
        showSuccessToast(data.message || 'Student added successfully.');
        addStudentModal.hide();
        loadStudents(); // Refresh list
      } else {
        showErrorToast(data.error || 'Failed to add student.');
      }
    })
    .catch(error => {
      console.error('Error adding student:', error);
      showErrorToast('An error occurred while adding the student.');
    });
  });

  // Clear All Students Modal Logic
  document.getElementById('clearAllStudentsBtn').addEventListener('click', function() {
    document.getElementById('clearStudentCount').textContent = allStudents.length;
    clearAllStudentsModal.show();
  });

  document.getElementById('confirmClearStudentsBtn').addEventListener('click', function() {
    fetch(buildApiUrl('/students/all'), { method: 'DELETE' })
    .then(response => response.json().then(data => ({ ok: response.ok, data })))
    .then(({ ok, data }) => {
      if (ok) {
        showSuccessToast(data.message || 'All students cleared.');
        clearAllStudentsModal.hide();
        loadStudents(); // Refresh list
      } else {
        showErrorToast(data.error || 'Failed to clear students.');
      }
    })
    .catch(error => {
      console.error('Error clearing students:', error);
      showErrorToast('An error occurred while clearing students.');
    });
  });
  
  // Create Ticket Modal Logic
  document.getElementById('submitTicketBtn').addEventListener('click', function() {
    const subject = document.getElementById('ticketSubject').value;
    const queue = document.getElementById('ticketQueue').value;
    const content = document.getElementById('ticketContent').value;
    const deviceId = document.getElementById('ticketDeviceId').value;
    const studentId = document.getElementById('ticketStudentId').value;

    if (!subject || !content) {
      showErrorToast('Subject and Description are required for the ticket.');
      return;
    }

    const ticketPayload = {
      subject: subject,
      queue: queue,
      content: content,
      device_id: deviceId,
      student_id: studentId 
    };
    
    console.log("Submitting ticket with payload:", ticketPayload);

    fetch(buildApiUrl('/rt/tickets/create'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(ticketPayload)
    })
    .then(response => response.json().then(data => ({ ok: response.ok, data })))
    .then(({ ok, data }) => {
      if (ok && data.ticket_id) {
        document.getElementById('ticketNumber').textContent = `Ticket #${data.ticket_id}`;
        document.getElementById('ticketSuccessMessage').style.display = 'block';
        // Optionally close modal after a delay or keep it open
        setTimeout(() => {
            createTicketModal.hide();
            document.getElementById('ticketSuccessMessage').style.display = 'none'; // Reset for next time
        }, 3000);
      } else {
        showErrorToast(data.error || 'Failed to create ticket.');
        console.error("Ticket creation error response:", data);
      }
    })
    .catch(error => {
      console.error('Error creating ticket:', error);
      showErrorToast('An error occurred while creating the ticket.');
    });
  });


  function loadStudents() {
    loadingIndicator.style.display = 'block';
    studentTableContainer.style.display = 'none';
    noResultsMessage.style.display = 'none';
    studentTableFooter.innerHTML = ''; // Clear footer, remove debug button if it was there

    fetch(buildApiUrl('/students'))
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        allStudents = data.students.map(student => {
          // Initialize device and RT device related properties
          student.devices = student.devices || [];
          if (student.rt_user_id) {
            student.rt_devices_loaded = false;
            student.rt_load_error = false;
            student.rt_devices_loading = false;
            student.rt_devices = student.rt_devices || [];
          }
          return student;
        });
        console.log('Students loaded:', allStudents.length);
        renderStudentTable();
        loadingIndicator.style.display = 'none';
        if (allStudents.length > 0) {
          studentTableContainer.style.display = 'block';
        } else {
          noResultsMessage.textContent = 'No students found in the system.';
          noResultsMessage.style.display = 'block';
        }
        // Automatically load RT devices for visible students after a short delay
        // This allows the main table to render first.
        setTimeout(loadRTDevicesForVisibleStudents, 100); // Reduced delay
      })
      .catch(error => {
        console.error('Error loading students:', error);
        loadingIndicator.style.display = 'none';
        studentTableContainer.style.display = 'none';
        noResultsMessage.textContent = 'Error loading student data. Please try again.';
        noResultsMessage.style.display = 'block';
        showErrorToast('Failed to load student data.');
      });
  }

  function filterStudents() {
    const selectedGrades = Array.from(gradeCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);
    const status = statusFilter.value;
    const searchTerm = searchInput.value.toLowerCase();

    const filteredStudents = allStudents.filter(student => {
      const gradeMatch = selectedGrades.length === 0 || selectedGrades.includes(student.grade.toString());
      const statusMatch = status === 'all' || 
                          (status === 'checked_in' && student.devices.some(d => d.status === 'Checked In')) ||
                          (status === 'not_checked_in' && !student.devices.some(d => d.status === 'Checked In'));
      const searchMatch = !searchTerm || 
                          student.first_name.toLowerCase().includes(searchTerm) ||
                          student.last_name.toLowerCase().includes(searchTerm) ||
                          student.id.toString().toLowerCase().includes(searchTerm);
      return gradeMatch && statusMatch && searchMatch;
    });
    
    renderStudentTable(filteredStudents);
    // After filtering, RT devices for newly visible students might need loading
    // The current loadRTDevicesForVisibleStudents iterates allStudents and checks flags,
    // so it should eventually pick them up if they weren't loaded.
    // A more targeted approach could be to call loadRTDevicesForVisibleStudents(filteredStudents)
    // but the current one is simpler and robust due to flag checks.
  }

  function generateRtDeviceInfoHtml(student) {
    if (!student || !student.rt_user_id) {
        return ''; 
    }

    if (student.rt_devices_loading) {
        return `<div class="mt-1"><small class="text-muted"><span class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></span> Loading RT data...</small></div>`;
    }

    if (student.rt_devices_loaded) {
        if (student.rt_load_error) {
            // Consider adding a retry button here later if manual loading is implemented
            return '<div class="mt-1"><small class="text-danger">Error loading RT data.</small></div>';
        } else if (student.rt_devices && student.rt_devices.length > 0) {
            let rtItems = student.rt_devices.map(device => {
                const deviceName = escapeHtml(device.Name || 'Unknown Device');
                const deviceId = escapeHtml(device.Id || 'N/A');
                return `<li class="list-group-item d-flex justify-content-between align-items-center p-1">
                          <small>${deviceName} (Asset: ${deviceId})</small>
                          <button class="btn btn-sm btn-outline-secondary p-0 px-1 create-rt-ticket-btn-inline" 
                                  data-device-id="${escapeHtml(device.Id)}" 
                                  data-device-name="${escapeHtml(deviceName)}" 
                                  data-student-id="${escapeHtml(student.id)}" 
                                  title="Create RT Ticket for this device">
                            <i class="bi bi-ticket-detailed"></i>
                          </button>
                        </li>`;
            }).join('');
            return `<div class="mt-1"><small class="text-muted">RT Devices:</small><ul class="list-group list-group-flush small">${rtItems}</ul></div>`;
        } else {
            return '<div class="mt-1"><small class="text-muted">No RT devices found.</small></div>';
        }
    } else {
        // Not loaded yet, and not actively loading implies it's pending initial load.
        return `<div class="mt-1"><small class="text-muted"><span class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></span> Loading RT data...</small></div>`;
    }
  }

  function generateFullDeviceInfoCellHtml(student) {
      let deviceInfoContent = '';
      if (student.devices && student.devices.length > 0) {
          deviceInfoContent = student.devices.map(device => {
              const status = escapeHtml(device.status || 'Unknown');
              const name = escapeHtml(device.name || 'Unnamed Device');
              const serial = escapeHtml(device.serial_number || 'N/A');
    // Get IDs of students currently visible in the table
    const visibleRows = document.querySelectorAll('#studentTableBody tr');
    if (visibleRows.length === 0) return;
    
    console.log(`Loading RT device data for ${visibleRows.length} visible students (one at a time)`);
    
    // Process each student one at a time
    visibleRows.forEach(row => {
      const studentId = row.getAttribute('data-student-id');
      if (!studentId) return;
      
      // Skip if we already have the RT devices for this student
      const student = allStudents.find(s => s.id === studentId);
      if (student && student.rt_devices) return;
      
      // Set loading state for the RT device cell
      const rtDevicesTd = row.querySelector('td:nth-child(6)'); // Adjust index if needed
      if (rtDevicesTd) {
        // Preserve existing device info and only add RT loading indicator
        const deviceInfoContent = rtDevicesTd.innerHTML;
        // Check if we already have a loading indicator
        if (!deviceInfoContent.includes('Loading RT data')) {
          // Keep only the first line of content (device info) and add loading indicator
          const deviceInfo = deviceInfoContent.split('<div')[0];
          rtDevicesTd.innerHTML = deviceInfo + '<div class="mt-1"><small class="text-muted"><span class="spinner-border spinner-border-sm text-secondary" role="status"></span> Loading RT data...</small></div>';
        }
      }
      
      // Fetch RT device data for this student individually
      fetch(buildApiUrl(`/api/students/${studentId}/rt-devices`), {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Server returned status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log(`Received RT devices for student ${studentId}:`, data);
        
        // Update allStudents array with RT device data
        const student = allStudents.find(s => s.id === studentId);
        if (student) {
          // Make sure we have a proper devices array even if the response format is unexpected
          student.rt_devices = (data && data.devices) ? data.devices : [];
          
          // Log the devices to help diagnose issues
          console.log(`Student ${studentId} now has ${student.rt_devices.length} RT devices in memory`);
          
          // Find the row to update the UI
          const row = document.querySelector(`#studentTableBody tr[data-student-id="${studentId}"]`);
          if (row) {
            // Get the device cell 
            const rtDevicesTd = row.querySelector('td:nth-child(6)');
            if (rtDevicesTd) {
              // Get the current device info (before RT data)
              let deviceInfoContent = '';
              if (student.device_checked_in) {
                const deviceInfo = student.device_info || {};
                deviceInfoContent = `${deviceInfo.asset_tag || ''} ${deviceInfo.device_type ? '(' + deviceInfo.device_type + ')' : ''}`;
              } else {
                deviceInfoContent = '-';
              }
              
              // Build RT device info display
              let rtInfo = '';
              if (student.rt_devices.length > 0) {
                const rtDeviceCount = student.rt_devices.length;
                const firstDevice = student.rt_devices[0];
                let deviceType = 'Unknown';
                
                // Extract device type from CustomFields if available
                if (firstDevice.CustomFields) {
                  const typeField = firstDevice.CustomFields.find(field => field.name === 'Type' && field.values && field.values.length > 0);
                  if (typeField) {
                    deviceType = typeField.values[0];
                  }
                }
                
                // Create RT device info display
                rtInfo = `<div class="mt-1"><small class="text-muted">RT: ${firstDevice.Name || 'Unknown'} (${deviceType})${
                  rtDeviceCount > 1 ? ` +${rtDeviceCount - 1} more` : ''
                }</small></div>`;
              } else {
                rtInfo = '<div class="mt-1"><small class="text-muted">No RT devices found</small></div>';
              }
              
              // Replace the entire cell content with updated information
              rtDevicesTd.innerHTML = deviceInfoContent + rtInfo;
            }
          }
        }
        
        // Log update complete for debugging
        console.log(`RT device info update completed for student ${studentId}`);
      })
      .catch(error => {
        console.error(`Error loading RT devices for student ${studentId}:`, error);
        // Update the UI to show error state for this student row
        const row = document.querySelector(`#studentTableBody tr[data-student-id="${studentId}"]`);
        
        // Update the student object to prevent repeated attempts to load data
        const student = allStudents.find(s => s.id === studentId);
        if (student) {
          student.rt_devices = []; // Set to empty array to indicate we've tried loading
          
          // Update the visible table row
          if (row) {
            // Find the device info cell
            const rtDevicesTd = row.querySelector('td:nth-child(6)'); // 6th column is Device Info
            if (rtDevicesTd) {
              // Only replace the RT part of the cell content
              const deviceInfoContent = rtDevicesTd.innerHTML;
              if (deviceInfoContent.includes('Loading')) {
                const updatedContent = deviceInfoContent.replace(
                  /<div class="mt-1">.*?Loading RT data\.\.\..*?<\/div>/,
                  '<div class="mt-1"><small class="text-danger">Error loading RT data</small></div>'
                );
                rtDevicesTd.innerHTML = updatedContent;
              }
            }
          }
        }
      });
    });
  }
  
  // Update the RT device info in the table
  function updateRTDeviceInfo(studentIds = null) {
    // If specific student IDs are provided, only update those rows
    let rows;
    if (studentIds) {
      rows = Array.from(document.querySelectorAll('#studentTableBody tr')).filter(row => 
        studentIds.includes(row.getAttribute('data-student-id'))
      );
    } else {
      rows = document.querySelectorAll('#studentTableBody tr');
    }
    
    rows.forEach(row => {
      const studentId = row.getAttribute('data-student-id');
      const student = allStudents.find(s => s.id === studentId);
      if (!student) return;
      
      const rtDevicesTd = row.querySelector('td:nth-child(6)'); // Adjust index based on table structure
      if (!rtDevicesTd) return;
      
      // Get the current device info content (non-RT part)
      let deviceInfoContent = '';
      if (student.device_checked_in && rtDevicesTd.childNodes.length > 0) {
        // Get the text content of the first line (non-RT part)
        const firstLine = rtDevicesTd.childNodes[0].textContent;
        if (firstLine && firstLine.trim() !== '') {
          deviceInfoContent = firstLine;
        }
      }
      
      // Prepare the new cell content
      let cellContent = '';
      
      // Add device info if available and student is checked in
      if (student.device_checked_in) {
        const deviceInfo = student.device_info || {};
        cellContent = `${deviceInfo.asset_tag || ''} ${deviceInfo.device_type ? '(' + deviceInfo.device_type + ')' : ''}`;
      } else {
        cellContent = '-';
      }
      
      // Add RT device info based on data availability
      if (student.rt_devices && Array.isArray(student.rt_devices)) {
        if (student.rt_devices.length > 0) {
          const rtDeviceCount = student.rt_devices.length;
          const firstDevice = student.rt_devices[0];
          let deviceType = 'Unknown';
          
          // Extract device type from CustomFields if available
          if (firstDevice.CustomFields) {
            const typeField = firstDevice.CustomFields.find(field => field.name === 'Type' && field.values && field.values.length > 0);
            if (typeField) {
              deviceType = typeField.values[0];
            }
          }
          
          // Add RT device info as a div after the main content
          cellContent += `<div class="mt-1"><small class="text-muted">RT: ${firstDevice.Name || 'Unknown'} (${deviceType})${
            rtDeviceCount > 1 ? ` +${rtDeviceCount - 1} more` : ''
          }</small></div>`;
        } else {
          // No devices found, add info at the bottom
          cellContent += '<div class="mt-1"><small class="text-muted">No RT devices found</small></div>';
        }
      } else if (Array.isArray(student.rt_devices)) {
        // Empty array - no devices found
        cellContent += '<div class="mt-1"><small class="text-muted">No RT devices found</small></div>';
      } else if (student.rt_user_id) {
        // RT user ID exists but devices not loaded yet
        cellContent += '<div class="mt-1"><small class="text-muted">RT data not loaded</small></div>';
      } else {
        // No RT user ID assigned
        cellContent += '<div class="mt-1"><small class="text-muted">No RT user ID</small></div>';
      }
      
      // Update the cell content
      rtDevicesTd.innerHTML = cellContent;
    });
  }

  // Filter and display students based on selected filters
  function filterStudents() {
    // Get selected grades
    const selectedGrades = Array.from(document.querySelectorAll('.grade-filter:checked'))
      .map(checkbox => checkbox.value);
    
    // Get selected status
    const selectedStatus = statusFilter.value;
    
    // Get search term
    const searchTerm = searchInput.value.trim().toLowerCase();
    
    // Filter students
    const filteredStudents = allStudents.filter(student => {
      // Filter by grade (if any selected)
      if (selectedGrades.length > 0 && !selectedGrades.includes(student.grade)) {
        return false;
      }
      
      // Filter by status
      if (selectedStatus === 'checked_in' && !student.device_checked_in) {
        return false;
      }
      if (selectedStatus === 'not_checked_in' && student.device_checked_in) {
        return false;
      }
      
      // Filter by search term
      if (searchTerm) {
        const fullName = `${student.first_name} ${student.last_name}`.toLowerCase();
        const id = String(student.id).toLowerCase();
        
        if (!fullName.includes(searchTerm) && !id.includes(searchTerm)) {
          return false;
        }
      }
      
      return true;
    });
    
    // Update student count
    studentCount.textContent = `${filteredStudents.length} students`;
    
    // Render table
    renderStudentTable(filteredStudents);
    
    // Update dashboard statistics based on filtered students
    updateDashboardStats(filteredStudents);
    
    // After filtering and rendering, determine if RT device data should be loaded
    const MAX_AUTO_LOAD_COUNT = 50; // Maximum number of students for auto-loading RT data
    
    if (filteredStudents.length > 0 && filteredStudents.length <= MAX_AUTO_LOAD_COUNT) {
      // Only auto-load RT data if there's a reasonable number of students to display
      loadRTDevicesForVisibleStudents();
    } else if (filteredStudents.length > MAX_AUTO_LOAD_COUNT) {
      // Add a button to manually load RT data for larger result sets
      const loadRtButton = document.createElement('button');
      loadRtButton.className = 'btn btn-sm btn-outline-secondary mt-2';
      loadRtButton.innerHTML = '<i class="bi bi-download"></i> Load RT Device Data';
      loadRtButton.onclick = function() {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
        loadRTDevicesForVisibleStudents();
        // Remove the button after loading starts
        setTimeout(() => this.remove(), 2000);
      };
      
      // Add the button to the table container
      const tableFooter = document.querySelector('#studentTableFooter');
      if (tableFooter) {
        // Check if button already exists
        const existingButton = tableFooter.querySelector('button');
        if (existingButton) {
          tableFooter.replaceChild(loadRtButton, existingButton);
        } else {
          tableFooter.appendChild(loadRtButton);
        }
      }
    }
  }

  // Update dashboard statistics based on filtered students
  function updateDashboardStats(students) {
    // Calculate statistics
    const totalStudents = students.length;
    const checkedIn = students.filter(student => student.device_checked_in).length;
    const notCheckedIn = totalStudents - checkedIn;
    const completionRate = totalStudents > 0 ? (checkedIn / totalStudents * 100).toFixed(1) : '0.0';
    
    // Update statistics in dashboard
    document.getElementById('stat-total-students').textContent = totalStudents;
    document.getElementById('stat-checked-in').textContent = checkedIn;
    document.getElementById('stat-not-checked-in').textContent = notCheckedIn;
    document.getElementById('stat-completion-rate').textContent = `${completionRate}%`;
    
    // Update the labels to indicate they're based on filtered students
    const filterDescription = getFilterDescription();
    document.getElementById('stat-total-label').textContent = filterDescription;
    document.getElementById('stat-checked-label').textContent = filterDescription;
    document.getElementById('stat-pending-label').textContent = filterDescription;
    document.getElementById('stat-rate-label').textContent = filterDescription;
  }
  
  // Get a description of the current filter state
  function getFilterDescription() {
    const selectedGrades = Array.from(document.querySelectorAll('.grade-filter:checked'))
      .map(checkbox => checkbox.value);
    
    const statusFilter = document.getElementById('statusFilter').value;
    const searchTerm = document.getElementById('searchInput').value.trim();
    
    let description = 'All students';
    
    // Add grade filter description
    if (selectedGrades.length > 0) {
      if (selectedGrades.length === document.querySelectorAll('.grade-filter').length) {
        description = 'All grades';
      } else {
        description = `Grade${selectedGrades.length > 1 ? 's' : ''} ${selectedGrades.join(', ')}`;
      }
    }
    
    // Add status filter description
    if (statusFilter === 'checked_in') {
      description += ' - Checked in only';
    } else if (statusFilter === 'not_checked_in') {
      description += ' - Pending only';
    }
    
    // Add search description
    if (searchTerm) {
      description += ` - Search: "${searchTerm}"`;
    }
    
    // If filter is applied, indicate that the stats are filtered
    if (selectedGrades.length > 0 || statusFilter !== 'all' || searchTerm) {
      description += ' (filtered)';
    }
    
    return description;
  }

  // Render student table with filtered data
  function renderStudentTable(students) {
    // Hide loading indicator
    loadingIndicator.style.display = 'none';
    
    if (students.length === 0) {
      // Show no results message
      studentTableContainer.style.display = 'none';
      noResultsMessage.style.display = 'block';
      return;
    }
    
    // Show student table
    studentTableContainer.style.display = 'block';
    noResultsMessage.style.display = 'none';
    
    // Clear table body
    studentTableBody.innerHTML = '';
    
    // Add rows for each student
    students.forEach(student => {
      const row = document.createElement('tr');
      row.className = 'student-row';
      row.setAttribute('data-student-id', student.id);
      
      // Get device information
      const deviceInfo = student.device_info || {};
      
      // Format check-in date
      const checkInDate = student.check_in_date 
        ? new Date(student.check_in_date).toLocaleString() 
        : '-';
      
      // Get RT device information if available
      let rtDeviceInfo = '';
      if (student.rt_devices && student.rt_devices.length > 0) {
        const rtDeviceCount = student.rt_devices.length;
        const firstDevice = student.rt_devices[0];
        let deviceType = 'Unknown';
        
        // Extract device type from CustomFields if available
        if (firstDevice.CustomFields) {
          const typeField = firstDevice.CustomFields.find(field => field.name === 'Type' && field.values && field.values.length > 0);
          if (typeField) {
            deviceType = typeField.values[0];
          }
        }
        
        rtDeviceInfo = `<div class="mt-1"><small class="text-muted">RT: ${firstDevice.Name || 'Unknown'} (${deviceType})`;
        if (rtDeviceCount > 1) {
          rtDeviceInfo += ` +${rtDeviceCount - 1} more`;
        }
        rtDeviceInfo += '</small></div>';
      } else if (student.rt_user_id) {
        // If student has RT user ID but devices aren't loaded yet, show loading indicator
        rtDeviceInfo = `<div class="mt-1"><small class="text-muted"><span class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></span> Loading RT data...</small></div>`;
      } else {
        // No RT user ID available
        rtDeviceInfo = `<div class="mt-1"><small class="text-muted">No RT user ID</small></div>`;
      }
      
      // Create row content
      row.innerHTML = `
        <td>${student.id}</td>
        <td>${student.first_name}</td>
        <td>${student.last_name}</td>
        <td>${student.grade}</td>
        <td>
          ${student.device_checked_in 
            ? '<span class="badge bg-success">Checked In</span>' 
            : '<span class="badge bg-warning text-dark">Pending</span>'}
        </td>
        <td>
          ${student.device_checked_in 
            ? `${deviceInfo.asset_tag || ''} ${deviceInfo.device_type ? '(' + deviceInfo.device_type + ')' : ''}` 
            : '-'}
          ${rtDeviceInfo}
        </td>
        <td>${checkInDate}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary view-student" title="View Details">
              <i class="bi bi-eye"></i>
            </button>
            ${!student.device_checked_in ? 
              `<button class="btn btn-outline-success check-in-device" title="Check In Device">
                <i class="bi bi-box-arrow-in-down"></i>
              </button>` : 
              `<button class="btn btn-outline-warning check-out-device" title="Check Out Device">
                <i class="bi bi-box-arrow-up"></i>
              </button>`
            }
            ${!student.device_checked_in ? 
              `<button class="btn btn-outline-secondary manual-check-in" title="Manual Check In">
                <i class="bi bi-person-check"></i> Manual Check In
              </button>` : ''
            }
            ${(student.device_checked_in && student.device_info && student.device_info.asset_tag === 'MANUAL' && student.device_info.device_type === 'No Device') ?
              `<button class="btn btn-outline-danger undo-manual-check-in" title="Undo Manual Check-In">
                <i class="bi bi-arrow-counterclockwise"></i> Undo Manual Check-In
              </button>` : ''
            }
          </div>
        </td>
      `;
      
      // Add event listeners to action buttons
      row.querySelector('.view-student').addEventListener('click', function() {
        showStudentDetails(student.id);
      });
      
      const checkInBtn = row.querySelector('.check-in-device');
      if (checkInBtn) {
        checkInBtn.addEventListener('click', function() {
          showStudentDetails(student.id, 'check-in');
        });
      }
      
      const checkOutBtn = row.querySelector('.check-out-device');
      if (checkOutBtn) {
        checkOutBtn.addEventListener('click', function() {
          if (confirm(`Are you sure you want to mark ${student.first_name} ${student.last_name}'s device as not checked in?`)) {
            checkOutStudentDevice(student.id);
          }
        });
      }

      const manualCheckInBtn = row.querySelector('.manual-check-in');
      if (manualCheckInBtn) {
        manualCheckInBtn.addEventListener('click', function() {
          const row = this.closest('tr');
          const studentId = row.getAttribute('data-student-id') || currentStudentId;
          fetch(buildApiUrl(`/api/students/${studentId}/check-in`), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ manual: true })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('successToast', 'Student checked in manually');
              loadStudents();
            } else {
              showToast('errorToast', data.error || 'Failed to check in student');
            }
          });
        });
      }

      const undoManualCheckInBtn = row.querySelector('.undo-manual-check-in');
      if (undoManualCheckInBtn) {
        undoManualCheckInBtn.addEventListener('click', function() {
          const row = this.closest('tr');
          const studentId = row.getAttribute('data-student-id') || currentStudentId;
          fetch(buildApiUrl(`/api/students/${studentId}/undo-manual-check-in`), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('successToast', 'Manual check-in undone');
              loadStudents();
            } else {
              showToast('errorToast', data.error || 'Failed to undo manual check-in');
            }
          });
        });
      }

      // Undo manual check-in
      const undoManualBtn = row.querySelector('.undo-manual-check-in');
      if (undoManualBtn) {
        undoManualBtn.addEventListener('click', function() {
          const studentId = row.getAttribute('data-student-id') || currentStudentId;
          fetch(buildApiUrl(`/api/students/${studentId}/undo-manual-checkin`), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('successToast', 'Manual check-in has been undone');
              loadStudents();
            } else {
              showToast('errorToast', data.error || 'Failed to undo manual check-in');
            }
          });
        });
      }
      
      // Add row to table
      studentTableBody.appendChild(row);
    });
  }

  // Show student details in modal
  function showStudentDetails(studentId, action = null) {
    currentStudentId = studentId;
    
    // Find student in our local data first for faster display
    const localStudentData = allStudents.find(s => s.id === studentId);
    
    // Fetch fresh data from server (which will include RT device data)
    fetch(buildApiUrl(`/api/students/${studentId}`))
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        
        // If we already displayed data from local cache, update it
        if (studentData && studentData.id === studentId) {
          // Update the RT devices if they've been loaded
          if (data.rt_devices && data.rt_devices.length) {
            studentData.rt_devices = data.rt_devices;
            updateRTDevicesInModal();
          }
        } else {
          // First time displaying this student
          studentData = data;
        }
        
        // Update modal title
        document.getElementById('viewStudentTitle').textContent = 
          `Student Details: ${data.first_name} ${data.last_name}`;
        
        // Populate student details
        document.getElementById('studentDetails').innerHTML = `
          <li class="list-group-item"><strong>ID:</strong> ${data.id}</li>
          <li class="list-group-item"><strong>Name:</strong> ${data.first_name} ${data.last_name}</li>
          <li class="list-group-item"><strong>Grade:</strong> ${formatGrade(data.grade)}</li>
          <li class="list-group-item"><strong>Status:</strong> 
            ${data.device_checked_in 
              ? '<span class="badge bg-success">Checked In</span>' 
              : '<span class="badge bg-warning text-dark">Pending</span>'}
          </li>
          ${data.check_in_date 
            ? `<li class="list-group-item"><strong>Check-in Date:</strong> ${new Date(data.check_in_date).toLocaleString()}</li>` 
            : ''}
          ${data.rt_user_id 
            ? `<li class="list-group-item"><strong>RT User ID:</strong> ${data.rt_user_id}</li>` 
            : ''}
        `;
        
        // Populate device info
        const deviceInfoContainer = document.getElementById('deviceInfo');
        if (data.device_info) {
          deviceInfoContainer.innerHTML = `
            <ul class="list-group list-group-flush">
              <li class="list-group-item"><strong>Asset ID:</strong> ${data.device_info.asset_id || 'N/A'}</li>
              <li class="list-group-item"><strong>Asset Tag:</strong> ${data.device_info.asset_tag || 'N/A'}</li>
              <li class="list-group-item"><strong>Device Type:</strong> ${data.device_info.device_type || 'N/A'}</li>
              <li class="list-group-item"><strong>Serial Number:</strong> ${data.device_info.serial_number || 'N/A'}</li>
              <li class="list-group-item"><strong>Check-in Timestamp:</strong> 
                ${data.device_info.check_in_timestamp 
                  ? new Date(data.device_info.check_in_timestamp).toLocaleString()
                  : 'N/A'}
              </li>
            </ul>
          `;
        } else {
          deviceInfoContainer.innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              No device check-in information available.
            </div>
          `;
        }
        
        // Setup RT device lookup
        document.getElementById('rtDevicesContainer').style.display = 'none';
        rtDevices = null;
        
        // Configure action buttons
        const checkInBtn = document.getElementById('checkInDeviceBtn');
        const checkOutBtn = document.getElementById('checkOutDeviceBtn');
        
        checkInBtn.style.display = data.device_checked_in ? 'none' : 'block';
        checkOutBtn.style.display = data.device_checked_in ? 'block' : 'none';
        
        // Show/hide Check In All Devices button
        const checkInAllBtn = document.getElementById('checkInAllDevicesBtn');
        if (rtDevices && rtDevices.length > 0 && !data.device_checked_in) {
          checkInAllBtn.style.display = 'block';
        } else {
          checkInAllBtn.style.display = 'none';
        }

        // Show the modal
        viewStudentModal.show();
        
        // If specific action was requested, trigger automatically
        if (action === 'check-in' && data.rt_user_id) {
          // Automatically trigger RT device lookup
          document.getElementById('lookupRTDevicesBtn').click();
        }
      })
      .catch(error => {
        showToast('errorToast', error.message);
      });
  }

  // Format grade for display
  function formatGrade(grade) {
    if (grade === 'K') return 'Kindergarten';
    
    const suffixes = {
      '1': 'st',
      '2': 'nd',
      '3': 'rd'
    };
    
    const suffix = suffixes[grade] || 'th';
    return `${grade}${suffix} Grade`;
  }
  
  // RT device lookup
  document.getElementById('lookupRTDevicesBtn').addEventListener('click', function() {
    if (!studentData || !studentData.rt_user_id) {
      document.getElementById('rtDevicesList').innerHTML = `
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          This student doesn't have an RT User ID assigned.
        </div>
      `;
      document.getElementById('rtDevicesContainer').style.display = 'block';
      return;
    }
    
    // Show loading indicator
    document.getElementById('rtDevicesList').innerHTML = `
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading devices from RT...</p>
      </div>
    `;
    document.getElementById('rtDevicesContainer').style.display = 'block';
    
    // First, check if we already have RT device data in studentData
    if (studentData.rt_devices && studentData.rt_devices.length > 0) {
      updateRTDevicesInModal();
      return;
    }
    
    // Otherwise, fetch devices from RT
    fetch(buildApiUrl(`/api/rt-lookup/student/${currentStudentId}?rt_user_id=${studentData.rt_user_id}`))
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        
        // Store the RT devices in studentData for future use
        studentData.rt_devices = data.assets;
        
        // Also update the student in allStudents array
        const localStudent = allStudents.find(s => s.id === currentStudentId);
        if (localStudent) {
          localStudent.rt_devices = data.assets;
        }
        
        // Store rtDevices for the current student to access elsewhere
        rtDevices = data.assets;
        
        // Update the RT devices display using our helper function
        updateRTDevicesInModal();
      })
      .catch(error => {
        document.getElementById('rtDevicesList').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-circle me-2"></i>
            Error looking up devices: ${error.message}
          </div>
        `;
      });
  });

  // Check in selected device
  document.getElementById('checkInDeviceBtn').addEventListener('click', function() {
    const selectedRadio = document.querySelector('input[name="rtDeviceSelect"]:checked');
    if (!selectedRadio) {
      showToast('errorToast', 'Please select a device to check in');
      return;
    }
    const deviceIndex = parseInt(selectedRadio.dataset.index);
    const selectedDevice = rtDevices[deviceIndex];
    checkInStudentDevice(currentStudentId, selectedDevice);
  });

  // Check out device button
  document.getElementById('checkOutDeviceBtn').addEventListener('click', function() {
    if (confirm(`Are you sure you want to mark this device as not checked in?`)) {
      checkOutStudentDevice(currentStudentId);
    }
  });

  // Check in student device
  function checkInStudentDevice(studentId, deviceData = null) {
    const requestBody = deviceData ? { asset_data: deviceData } : {};
    
    fetch(buildApiUrl(`/api/students/${studentId}/check-in`), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('successToast', 'Device checked in successfully');
        viewStudentModal.hide();
        
        // Reload students to update the list
        loadStudents();
      } else {
        throw new Error(data.error || 'Failed to check in device');
      }
    })
    .catch(error => {
      showToast('errorToast', error.message);
    });
  }

  // Check out student device
  function checkOutStudentDevice(studentId) {
    fetch(buildApiUrl(`/api/students/${studentId}/check-out`), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('successToast', 'Device marked as not checked in');
        viewStudentModal.hide();
        
        // Reload students to update the list
        loadStudents();
      } else {
        throw new Error(data.error || 'Failed to mark device as not checked in');
      }
    })
    .catch(error => {
      showToast('errorToast', error.message);
    });
  }

  // Toast helper function
  function showToast(toastId, message) {
    const toast = document.getElementById(toastId);
    const toastMessage = document.getElementById(`${toastId}Message`);
    toastMessage.textContent = message;
    
    const bsToast = bootstrap.Toast.getInstance(toast) || new bootstrap.Toast(toast);
    bsToast.show();
  }

  // Check In All Devices button
  document.getElementById('checkInAllDevicesBtn').addEventListener('click', function() {
    if (!rtDevices || rtDevices.length === 0) {
      showToast('errorToast', 'No RT devices found to check in.');
      return;
    }
    const button = this;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
    fetch(buildApiUrl(`/api/students/${currentStudentId}/check-in-all`), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('successToast', data.message || 'All devices checked in successfully');
        viewStudentModal.hide();
        loadStudents();
      } else {
        throw new Error(data.error || 'Failed to check in all devices');
      }
    })
    .catch(error => {
      showToast('errorToast', error.message);
    })
    .finally(() => {
      button.disabled = false;
      button.innerHTML = originalText;
    });
  });

  // Handle creating tickets for devices
  document.addEventListener('click', function(event) {
    if (event.target.classList.contains('create-ticket-btn') || 
        event.target.closest('.create-ticket-btn')) {
      
      const button = event.target.classList.contains('create-ticket-btn') ? 
                     event.target : 
                     event.target.closest('.create-ticket-btn');
      
      // Get data attributes
      const deviceId = button.dataset.deviceId;
      const deviceName = button.dataset.deviceName;
      const deviceType = button.dataset.deviceType;
      const deviceSerial = button.dataset.deviceSerial;
      
      // Set data in modal
      document.getElementById('ticketDeviceId').value = deviceId;
      document.getElementById('ticketDeviceName').value = deviceName;
      document.getElementById('ticketStudentId').value = currentStudentId;
      
      // Set default subject with device info
      document.getElementById('ticketSubject').value = `Issue with ${deviceName} (${deviceType})`;
      
      // Populate ticket content with device details
      document.getElementById('ticketContent').value = 
        `Device Details:\n` +
        `- Asset Tag: ${deviceName}\n` +
        `- Type: ${deviceType}\n` +
        `- Serial Number: ${deviceSerial}\n` +
        `- Student: ${studentData.first_name} ${studentData.last_name} (${studentData.id})\n\n` +
        `Issue Description:\n`;
      
      // Hide any previous success message
      document.getElementById('ticketSuccessMessage').style.display = 'none';
      
      // Show modal
      createTicketModal.show();
    }
  });
  
  // Handle ticket submission
  document.getElementById('submitTicketBtn').addEventListener('click', function() {
    const form = document.getElementById('createTicketForm');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    
    const ticketData = {
      subject: document.getElementById('ticketSubject').value,
      body: document.getElementById('ticketContent').value,
      queue: document.getElementById('ticketQueue').value,
      device_id: document.getElementById('ticketDeviceId').value,
      device_name: document.getElementById('ticketDeviceName').value,
      student_id: document.getElementById('ticketStudentId').value
    };
    
    // Disable button while processing
    const button = this;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
    
    // Call API to create ticket
    fetch('/api/tickets/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(ticketData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        document.getElementById('ticketNumber').textContent = `Ticket #${data.ticket_id} created`;
        document.getElementById('ticketSuccessMessage').style.display = 'block';
        
        // Clear form for next use
        document.getElementById('ticketSubject').value = '';
        document.getElementById('ticketContent').value = '';
        
        // Show toast
        showToast('successToast', `Ticket #${data.ticket_id} created successfully`);
      } else {
        throw new Error(data.error || 'Failed to create ticket');
      }
    })
    .catch(error => {
      showToast('errorToast', error.message);
    })
    .finally(() => {
      // Re-enable button
      button.disabled = false;
      button.innerHTML = originalText;
    });
  });

  // Update RT devices in student modal
  function updateRTDevicesInModal() {
    if (!studentData || !studentData.rt_devices) return;
    
    const rtDevicesList = document.getElementById('rtDevicesList');
    if (!rtDevicesList) return;
    
    // If there are no RT devices, show a message
    if (!studentData.rt_devices.length) {
      rtDevicesList.innerHTML = '<div class="alert alert-info">No devices assigned in RT</div>';
      document.getElementById('rtDevicesContainer').style.display = 'block';
      return;
    }
    
    // Enable Check In All Devices button if applicable
    const checkInAllBtn = document.getElementById('checkInAllDevicesBtn');
    if (checkInAllBtn && !studentData.device_checked_in) {
      checkInAllBtn.style.display = 'block';
    }
    
    // Build the table display with device data
    let devicesHtml = `
      <table class="table table-sm table-striped">
        <thead>
          <tr>
            <th>Select</th>
            <th>Asset Tag</th>
            <th>Type</th>
            <th>Serial Number</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    // Process each device
    studentData.rt_devices.forEach((device, index) => {
      // Extract device details
      const assetTag = device.Name || 'N/A';
      
      // Extract device type and serial from CustomFields
      let deviceType = 'Unknown';
      let serialNumber = 'N/A';
      
      if (device.CustomFields) {
        const typeField = device.CustomFields.find(field => field.name === 'Type' && field.values && field.values.length > 0);
        if (typeField) {
          deviceType = typeField.values[0];
        }
        
        const serialField = device.CustomFields.find(field => field.name === 'Serial Number' && field.values && field.values.length > 0);
        if (serialField) {
          serialNumber = serialField.values[0];
        }
      }
      
      devicesHtml += `
        <tr>
          <td>
            <input type="radio" name="rtDeviceSelect" id="rtDevice${index}" value="${device.id}" data-index="${index}">
          </td>
          <td>${assetTag}</td>
          <td>${deviceType}</td>
          <td>${serialNumber}</td>
          <td>
            <button type="button" class="btn btn-sm btn-outline-primary create-ticket-btn" 
              data-device-id="${device.id}" 
              data-device-name="${assetTag}" 
              data-device-type="${deviceType}"
              data-device-serial="${serialNumber}">
              <i class="bi bi-ticket-perforated"></i> Create Ticket
            </button>
          </td>
        </tr>
      `;
    });
    
    devicesHtml += `
      </tbody>
    </table>
    `;
    rtDevicesList.innerHTML = devicesHtml;
    document.getElementById('rtDevicesContainer').style.display = 'block';
    
    // Add event listeners for radio buttons
    document.querySelectorAll('input[name="rtDeviceSelect"]').forEach(radio => {
      radio.addEventListener('change', function() {
        // Enable the check-in button when a device is selected
        document.getElementById('checkInDeviceBtn').disabled = false;
      });
    });
    
    // Add event listeners to Create Ticket buttons
    rtDevicesList.querySelectorAll('.create-ticket-btn').forEach(button => {
      button.addEventListener('click', function() {
        // Set up ticket data
        document.getElementById('ticketDeviceId').value = this.getAttribute('data-device-id');
        document.getElementById('ticketDeviceName').value = this.getAttribute('data-device-name');
        
        // Create a dynamic subject based on device info
        const deviceName = this.getAttribute('data-device-name');
        const deviceType = this.getAttribute('data-device-type');
        document.getElementById('ticketSubject').value = `Issue with ${deviceName} (${deviceType})`;
        
        // Set ticket description with device info
        const serialNumber = this.getAttribute('data-device-serial');
        let ticketContent = `Device: ${deviceName}\nType: ${deviceType}`;
        if (serialNumber) {
          ticketContent += `\nSerial Number: ${serialNumber}`;
        }
        ticketContent += '\n\nDescription of issue:\n';
        document.getElementById('ticketContent').value = ticketContent;
        
        // Store student ID
        document.getElementById('ticketStudentId').value = currentStudentId;
        
        // Hide previous success message
        document.getElementById('ticketSuccessMessage').style.display = 'none';
        
        // Show the modal
        viewStudentModal.hide();
        createTicketModal.show();
      });
    });
  }
});
</script>
{% endblock %}