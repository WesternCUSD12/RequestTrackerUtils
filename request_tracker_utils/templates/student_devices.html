{% extends 'base.html' %}

{% block title %}Student Device Check-in List{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Breadcrumb Navigation -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/devices">Devices</a></li>
      <li class="breadcrumb-item active" aria-current="page">Student Device List</li>
    </ol>
  </nav>

  <div class="row mb-4">
    <div class="col-12">
      <h1 class="mb-3">Student Device Tracking</h1>
      <p class="lead">Track device check-ins by grade for the {{ current_year }} school year.</p>
    </div>
  </div>

  <!-- Dashboard Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body">
          <h5 class="card-title">Total Students</h5>
          <h2 class="display-4">{{ stats.total_students }}</h2>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body">
          <h5 class="card-title">Checked In</h5>
          <h2 class="display-4">{{ stats.checked_in }}</h2>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card bg-warning text-dark h-100">
        <div class="card-body">
          <h5 class="card-title">Pending</h5>
          <h2 class="display-4">{{ stats.not_checked_in }}</h2>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body">
          <h5 class="card-title">Completion Rate</h5>
          <h2 class="display-4">{{ "%.1f"|format(stats.completion_rate) }}%</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body d-flex justify-content-between">
          <div>
            <button id="refreshStudentsBtn" class="btn btn-outline-primary me-2">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <a href="{{ url_for('students.student_import') }}" class="btn btn-outline-success me-2">
              <i class="bi bi-file-earmark-arrow-up"></i> Import Students
            </a>
            <a href="{{ url_for('students.student_export') }}" class="btn btn-outline-secondary me-2">
              <i class="bi bi-file-earmark-arrow-down"></i> Export CSV
            </a>
          </div>
          <div>
            <button id="addStudentBtn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
              <i class="bi bi-person-plus"></i> Add Student
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Student Filtering Controls -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Filter Students</h5>
        </div>
        <div class="card-body">
          <!-- Filter form -->
          <form id="filterForm" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Grade Levels</label>
              <div id="gradeCheckboxes" class="d-flex flex-wrap gap-2">
                {% for grade in ['6', '7', '8', '9', '10', '11', '12'] %}
                <div class="form-check form-check-inline">
                  <input class="form-check-input grade-filter" type="checkbox" value="{{ grade }}" id="grade{{ grade }}">
                  <label class="form-check-label" for="grade{{ grade }}">
                    Grade {{ grade }}
                  </label>
                </div>
                {% endfor %}
                <!-- Grade quick selection buttons -->
                <div class="ms-3">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllGrades">Select All</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllGrades">Clear</button>
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <label for="statusFilter" class="form-label">Check-in Status</label>
              <select class="form-select" id="statusFilter">
                <option value="all" selected>All Statuses</option>
                <option value="checked_in">Checked In</option>
                <option value="not_checked_in">Not Checked In</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label for="searchInput" class="form-label">Search Students</label>
              <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Name or ID...">
                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Student List with Loading State -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">Student Device List</h2>
      <span id="studentCount" class="badge bg-light text-dark">0 students</span>
    </div>
    <div class="card-body p-0">
      <!-- Loading indicator -->
      <div id="loadingIndicator" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading student data...</p>
      </div>
      
      <!-- Student table (initially hidden) -->
      <div id="studentTableContainer" class="table-responsive" style="display: none;">
        <table class="table table-striped table-hover mb-0" id="studentTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Grade</th>
              <th>Check-in Status</th>
              <th>Device Info</th>
              <th>Check-in Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="studentTableBody">
            <!-- Student rows will be inserted here by JavaScript -->
          </tbody>
        </table>
      </div>
      
      <!-- No results message (initially hidden) -->
      <div id="noResultsMessage" class="alert alert-info m-3" style="display: none;">
        <i class="bi bi-info-circle me-2"></i>
        No students match your current filters.
      </div>
    </div>
  </div>
  
  <!-- View Student Modal -->
  <div class="modal fade" id="viewStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewStudentTitle">Student Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">
                  <h5>Student Information</h5>
                </div>
                <div class="card-body">
                  <ul class="list-group list-group-flush" id="studentDetails">
                    <!-- Student details populated by JavaScript -->
                  </ul>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">
                  <h5>Device Information</h5>
                </div>
                <div class="card-body" id="deviceInfo">
                  <!-- Device info populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h5>RT Device Information</h5>
            </div>
            <div class="card-body" id="rtDeviceLookup">
              <!-- RT device lookup populated by JavaScript -->
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <p class="mb-2 text-muted">Lookup devices assigned to this student in RT</p>
                </div>
                <button class="btn btn-outline-primary" id="lookupRTDevicesBtn">
                  <i class="bi bi-search"></i> Lookup RT Devices
                </button>
              </div>
              
              <!-- Placeholder for RT devices display -->
              <div id="rtDevicesContainer" class="mt-3" style="display: none;">
                <h6 class="border-bottom pb-2">Assigned Devices in RT</h6>
                <div id="rtDevicesList">
                  <!-- RT Devices populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" id="checkInDeviceBtn" style="display: none;">
            <i class="bi bi-box-arrow-in-down"></i> Check In Device
          </button>
          <button type="button" class="btn btn-warning" id="checkOutDeviceBtn" style="display: none;">
            <i class="bi bi-box-arrow-up"></i> Check Out Device
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Student Modal -->
  <div class="modal fade" id="addStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addStudentForm">
            <div class="mb-3">
              <label for="studentId" class="form-label">Student ID</label>
              <input type="text" class="form-control" id="studentId" required>
            </div>
            <div class="mb-3">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="firstName" required>
            </div>
            <div class="mb-3">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="lastName" required>
            </div>
            <div class="mb-3">
              <label for="grade" class="form-label">Grade</label>
              <select class="form-select" id="grade">
                <option value="6">6th Grade</option>
                <option value="7">7th Grade</option>
                <option value="8">8th Grade</option>
                <option value="9">9th Grade</option>
                <option value="10">10th Grade</option>
                <option value="11">11th Grade</option>
                <option value="12">12th Grade</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="rtUserId" class="form-label">RT User ID (optional)</label>
              <input type="text" class="form-control" id="rtUserId">
              <div class="form-text">The Request Tracker user ID for device lookup</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveStudentBtn">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Messages -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-success text-white">
      <i class="bi bi-check-circle me-2"></i>
      <strong class="me-auto">Success</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="successToastMessage">
      Operation completed successfully.
    </div>
  </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-danger text-white">
      <i class="bi bi-exclamation-circle me-2"></i>
      <strong class="me-auto">Error</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="errorToastMessage">
      An error occurred.
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize variables
  let currentStudentId = null;
  let studentData = null;
  let rtDevices = null;
  let allStudents = [];
  
  // Initialize Bootstrap components
  const successToast = new bootstrap.Toast(document.getElementById('successToast'));
  const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));
  const addStudentModal = new bootstrap.Modal(document.getElementById('addStudentModal'));
  const viewStudentModal = new bootstrap.Modal(document.getElementById('viewStudentModal'));
  
  // DOM elements
  const loadingIndicator = document.getElementById('loadingIndicator');
  const studentTableContainer = document.getElementById('studentTableContainer');
  const studentTableBody = document.getElementById('studentTableBody');
  const noResultsMessage = document.getElementById('noResultsMessage');
  const studentCount = document.getElementById('studentCount');
  
  // Grade filter checkboxes
  const gradeCheckboxes = document.querySelectorAll('.grade-filter');
  const selectAllGradesBtn = document.getElementById('selectAllGrades');
  const clearAllGradesBtn = document.getElementById('clearAllGrades');
  
  // Status filter
  const statusFilter = document.getElementById('statusFilter');
  
  // Search input
  const searchInput = document.getElementById('searchInput');
  const clearSearchBtn = document.getElementById('clearSearch');
  
  // Initial data load
  loadStudents();
  
  // Add event listeners for filter controls
  gradeCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', filterStudents);
  });
  
  selectAllGradesBtn.addEventListener('click', function() {
    gradeCheckboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    filterStudents();
  });
  
  clearAllGradesBtn.addEventListener('click', function() {
    gradeCheckboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    filterStudents();
  });
  
  statusFilter.addEventListener('change', filterStudents);
  
  searchInput.addEventListener('input', filterStudents);
  
  clearSearchBtn.addEventListener('click', function() {
    searchInput.value = '';
    filterStudents();
  });
  
  // Refresh button
  document.getElementById('refreshStudentsBtn').addEventListener('click', function() {
    loadStudents();
  });
  
  // Add student form submission
  document.getElementById('saveStudentBtn').addEventListener('click', function() {
    const form = document.getElementById('addStudentForm');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    
    const studentData = {
      id: document.getElementById('studentId').value,
      first_name: document.getElementById('firstName').value,
      last_name: document.getElementById('lastName').value,
      grade: document.getElementById('grade').value
    };
    
    // Add RT User ID if provided
    const rtUserId = document.getElementById('rtUserId').value;
    if (rtUserId) {
      studentData.rt_user_id = rtUserId;
    }
    
    fetch('/api/students', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(studentData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('successToast', 'Student added successfully');
        addStudentModal.hide();
        
        // Reload students to include the new one
        loadStudents();
      } else {
        throw new Error(data.error || 'Failed to add student');
      }
    })
    .catch(error => {
      showToast('errorToast', error.message);
    });
  });

  // Load all students from API
  function loadStudents() {
    // Show loading indicator
    loadingIndicator.style.display = 'block';
    studentTableContainer.style.display = 'none';
    noResultsMessage.style.display = 'none';
    
    fetch('/api/students')
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        
        allStudents = data.students;
        
        // Apply filters and render table
        filterStudents();
      })
      .catch(error => {
        showToast('errorToast', error.message);
        loadingIndicator.style.display = 'none';
      });
  }

  // Filter and display students based on selected filters
  function filterStudents() {
    // Get selected grades
    const selectedGrades = Array.from(document.querySelectorAll('.grade-filter:checked'))
      .map(checkbox => checkbox.value);
    
    // Get selected status
    const selectedStatus = statusFilter.value;
    
    // Get search term
    const searchTerm = searchInput.value.trim().toLowerCase();
    
    // Filter students
    const filteredStudents = allStudents.filter(student => {
      // Filter by grade (if any selected)
      if (selectedGrades.length > 0 && !selectedGrades.includes(student.grade)) {
        return false;
      }
      
      // Filter by status
      if (selectedStatus === 'checked_in' && !student.device_checked_in) {
        return false;
      }
      if (selectedStatus === 'not_checked_in' && student.device_checked_in) {
        return false;
      }
      
      // Filter by search term
      if (searchTerm) {
        const fullName = `${student.first_name} ${student.last_name}`.toLowerCase();
        const id = String(student.id).toLowerCase();
        
        if (!fullName.includes(searchTerm) && !id.includes(searchTerm)) {
          return false;
        }
      }
      
      return true;
    });
    
    // Update student count
    studentCount.textContent = `${filteredStudents.length} students`;
    
    // Render table
    renderStudentTable(filteredStudents);
  }

  // Render student table with filtered data
  function renderStudentTable(students) {
    // Hide loading indicator
    loadingIndicator.style.display = 'none';
    
    if (students.length === 0) {
      // Show no results message
      studentTableContainer.style.display = 'none';
      noResultsMessage.style.display = 'block';
      return;
    }
    
    // Show student table
    studentTableContainer.style.display = 'block';
    noResultsMessage.style.display = 'none';
    
    // Clear table body
    studentTableBody.innerHTML = '';
    
    // Add rows for each student
    students.forEach(student => {
      const row = document.createElement('tr');
      row.className = 'student-row';
      row.setAttribute('data-student-id', student.id);
      
      // Get device information
      const deviceInfo = student.device_info || {};
      
      // Format check-in date
      const checkInDate = student.check_in_date 
        ? new Date(student.check_in_date).toLocaleString() 
        : '-';
      
      // Get RT device information if available
      let rtDeviceInfo = '';
      if (student.rt_devices && student.rt_devices.length > 0) {
        const rtDeviceCount = student.rt_devices.length;
        const firstDevice = student.rt_devices[0];
        let deviceType = 'Unknown';
        
        // Extract device type from CustomFields if available
        if (firstDevice.CustomFields) {
          const typeField = firstDevice.CustomFields.find(field => field.name === 'Type' && field.values && field.values.length > 0);
          if (typeField) {
            deviceType = typeField.values[0];
          }
        }
        
        rtDeviceInfo = `<div class="mt-1"><small class="text-muted">RT: ${firstDevice.Name || 'Unknown'} (${deviceType})`;
        if (rtDeviceCount > 1) {
          rtDeviceInfo += ` +${rtDeviceCount - 1} more`;
        }
        rtDeviceInfo += '</small></div>';
      }
      
      // Create row content
      row.innerHTML = `
        <td>${student.id}</td>
        <td>${student.first_name}</td>
        <td>${student.last_name}</td>
        <td>${student.grade}</td>
        <td>
          ${student.device_checked_in 
            ? '<span class="badge bg-success">Checked In</span>' 
            : '<span class="badge bg-warning text-dark">Pending</span>'}
        </td>
        <td>
          ${student.device_checked_in 
            ? `${deviceInfo.asset_tag || ''} ${deviceInfo.device_type ? '(' + deviceInfo.device_type + ')' : ''}` 
            : '-'}
          ${rtDeviceInfo}
        </td>
        <td>${checkInDate}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary view-student" title="View Details">
              <i class="bi bi-eye"></i>
            </button>
            ${!student.device_checked_in ? 
              `<button class="btn btn-outline-success check-in-device" title="Check In Device">
                <i class="bi bi-box-arrow-in-down"></i>
              </button>` : 
              `<button class="btn btn-outline-warning check-out-device" title="Check Out Device">
                <i class="bi bi-box-arrow-up"></i>
              </button>`
            }
          </div>
        </td>
      `;
      
      // Add event listeners to action buttons
      row.querySelector('.view-student').addEventListener('click', function() {
        showStudentDetails(student.id);
      });
      
      const checkInBtn = row.querySelector('.check-in-device');
      if (checkInBtn) {
        checkInBtn.addEventListener('click', function() {
          showStudentDetails(student.id, 'check-in');
        });
      }
      
      const checkOutBtn = row.querySelector('.check-out-device');
      if (checkOutBtn) {
        checkOutBtn.addEventListener('click', function() {
          if (confirm(`Are you sure you want to mark ${student.first_name} ${student.last_name}'s device as not checked in?`)) {
            checkOutStudentDevice(student.id);
          }
        });
      }
      
      // Add row to table
      studentTableBody.appendChild(row);
    });
  }

  // Show student details in modal
  function showStudentDetails(studentId, action = null) {
    currentStudentId = studentId;
    
    fetch(`/api/students/${studentId}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        
        studentData = data;
        
        // Update modal title
        document.getElementById('viewStudentTitle').textContent = 
          `Student Details: ${data.first_name} ${data.last_name}`;
        
        // Populate student details
        document.getElementById('studentDetails').innerHTML = `
          <li class="list-group-item"><strong>ID:</strong> ${data.id}</li>
          <li class="list-group-item"><strong>Name:</strong> ${data.first_name} ${data.last_name}</li>
          <li class="list-group-item"><strong>Grade:</strong> ${formatGrade(data.grade)}</li>
          <li class="list-group-item"><strong>Status:</strong> 
            ${data.device_checked_in 
              ? '<span class="badge bg-success">Checked In</span>' 
              : '<span class="badge bg-warning text-dark">Pending</span>'}
          </li>
          ${data.check_in_date 
            ? `<li class="list-group-item"><strong>Check-in Date:</strong> ${new Date(data.check_in_date).toLocaleString()}</li>` 
            : ''}
          ${data.rt_user_id 
            ? `<li class="list-group-item"><strong>RT User ID:</strong> ${data.rt_user_id}</li>` 
            : ''}
        `;
        
        // Populate device info
        const deviceInfoContainer = document.getElementById('deviceInfo');
        if (data.device_info) {
          deviceInfoContainer.innerHTML = `
            <ul class="list-group list-group-flush">
              <li class="list-group-item"><strong>Asset ID:</strong> ${data.device_info.asset_id || 'N/A'}</li>
              <li class="list-group-item"><strong>Asset Tag:</strong> ${data.device_info.asset_tag || 'N/A'}</li>
              <li class="list-group-item"><strong>Device Type:</strong> ${data.device_info.device_type || 'N/A'}</li>
              <li class="list-group-item"><strong>Serial Number:</strong> ${data.device_info.serial_number || 'N/A'}</li>
              <li class="list-group-item"><strong>Check-in Timestamp:</strong> 
                ${data.device_info.check_in_timestamp 
                  ? new Date(data.device_info.check_in_timestamp).toLocaleString()
                  : 'N/A'}
              </li>
            </ul>
          `;
        } else {
          deviceInfoContainer.innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              No device check-in information available.
            </div>
          `;
        }
        
        // Setup RT device lookup
        document.getElementById('rtDevicesContainer').style.display = 'none';
        rtDevices = null;
        
        // Configure action buttons
        const checkInBtn = document.getElementById('checkInDeviceBtn');
        const checkOutBtn = document.getElementById('checkOutDeviceBtn');
        
        checkInBtn.style.display = data.device_checked_in ? 'none' : 'block';
        checkOutBtn.style.display = data.device_checked_in ? 'block' : 'none';
        
        // Show the modal
        viewStudentModal.show();
        
        // If specific action was requested, trigger automatically
        if (action === 'check-in' && data.rt_user_id) {
          // Automatically trigger RT device lookup
          document.getElementById('lookupRTDevicesBtn').click();
        }
      })
      .catch(error => {
        showToast('errorToast', error.message);
      });
  }

  // Format grade for display
  function formatGrade(grade) {
    if (grade === 'K') return 'Kindergarten';
    
    const suffixes = {
      '1': 'st',
      '2': 'nd',
      '3': 'rd'
    };
    
    const suffix = suffixes[grade] || 'th';
    return `${grade}${suffix} Grade`;
  }
  
  // RT device lookup
  document.getElementById('lookupRTDevicesBtn').addEventListener('click', function() {
    if (!studentData || !studentData.rt_user_id) {
      document.getElementById('rtDevicesList').innerHTML = `
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          This student doesn't have an RT User ID assigned.
        </div>
      `;
      document.getElementById('rtDevicesContainer').style.display = 'block';
      return;
    }
    
    // Show loading indicator
    document.getElementById('rtDevicesList').innerHTML = `
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading devices from RT...</p>
      </div>
    `;
    document.getElementById('rtDevicesContainer').style.display = 'block';
    
    // Fetch devices from RT
    fetch(`/api/rt-lookup/student/${currentStudentId}?rt_user_id=${studentData.rt_user_id}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        
        rtDevices = data.assets;
        
        if (rtDevices && rtDevices.length > 0) {
          // Create a table of devices
          let devicesHtml = `
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Select</th>
                  <th>Asset Tag</th>
                  <th>Type</th>
                  <th>Serial Number</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          rtDevices.forEach((device, index) => {
            // Extract device details
            const assetTag = device.Name || 'N/A';
            
            // Extract device type and serial from CustomFields
            let deviceType = 'N/A';
            let serialNumber = 'N/A';
            
            if (device.CustomFields) {
              device.CustomFields.forEach(field => {
                if (field.name === 'Type' && field.values && field.values.length > 0) {
                  deviceType = field.values[0];
                }
                if (field.name === 'Serial Number' && field.values && field.values.length > 0) {
                  serialNumber = field.values[0];
                }
              });
            }
            
            devicesHtml += `
              <tr>
                <td>
                  <input type="radio" name="rtDeviceSelect" id="rtDevice${index}" value="${device.id}" data-index="${index}">
                </td>
                <td>${assetTag}</td>
                <td>${deviceType}</td>
                <td>${serialNumber}</td>
              </tr>
            `;
          });
          
          devicesHtml += `
              </tbody>
            </table>
          `;
          
          document.getElementById('rtDevicesList').innerHTML = devicesHtml;
          
          // Add event listeners for radio buttons
          document.querySelectorAll('input[name="rtDeviceSelect"]').forEach(radio => {
            radio.addEventListener('change', function() {
              // Enable the check-in button when a device is selected
              document.getElementById('checkInDeviceBtn').disabled = false;
            });
          });
        } else {
          document.getElementById('rtDevicesList').innerHTML = `
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              No devices assigned to this student in RT.
            </div>
          `;
        }
      })
      .catch(error => {
        document.getElementById('rtDevicesList').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-circle me-2"></i>
            Error looking up devices: ${error.message}
          </div>
        `;
      });
  });

  // Check in selected device
  document.getElementById('checkInDeviceBtn').addEventListener('click', function() {
    const selectedRadio = document.querySelector('input[name="rtDeviceSelect"]:checked');
    
    if (selectedRadio) {
      // Check in with selected RT device
      const deviceIndex = parseInt(selectedRadio.dataset.index);
      const selectedDevice = rtDevices[deviceIndex];
      
      checkInStudentDevice(currentStudentId, selectedDevice);
    } else {
      // Check in without device info
      checkInStudentDevice(currentStudentId);
    }
  });
  
  // Check out device button
  document.getElementById('checkOutDeviceBtn').addEventListener('click', function() {
    if (confirm(`Are you sure you want to mark this device as not checked in?`)) {
      checkOutStudentDevice(currentStudentId);
    }
  });

  // Check in student device
  function checkInStudentDevice(studentId, deviceData = null) {
    const requestBody = deviceData ? { asset_data: deviceData } : {};
    
    fetch(`/api/students/${studentId}/check-in`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('successToast', 'Device checked in successfully');
        viewStudentModal.hide();
        
        // Reload students to update the list
        loadStudents();
      } else {
        throw new Error(data.error || 'Failed to check in device');
      }
    })
    .catch(error => {
      showToast('errorToast', error.message);
    });
  }

  // Check out student device
  function checkOutStudentDevice(studentId) {
    fetch(`/api/students/${studentId}/check-out`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('successToast', 'Device marked as not checked in');
        viewStudentModal.hide();
        
        // Reload students to update the list
        loadStudents();
      } else {
        throw new Error(data.error || 'Failed to mark device as not checked in');
      }
    })
    .catch(error => {
      showToast('errorToast', error.message);
    });
  }

  // Toast helper function
  function showToast(toastId, message) {
    const toast = document.getElementById(toastId);
    const toastMessage = document.getElementById(`${toastId}Message`);
    toastMessage.textContent = message;
    
    const bsToast = bootstrap.Toast.getInstance(toast) || new bootstrap.Toast(toast);
    bsToast.show();
  }
});
</script>
{% endblock %}