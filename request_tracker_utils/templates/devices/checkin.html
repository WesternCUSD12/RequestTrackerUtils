{% extends "base.html" %}
{% load static %}

{% block title %}Device Check-In{% endblock %}

{% block extra_css %}
<style>
    .checkin-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
    }
    .checkin-form {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-control-lg {
        font-size: 18px;
        padding: 12px 16px;
        height: auto;
    }
    .device-details {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        display: none;
    }
    .device-details.show {
        display: block;
    }
    .error-message {
        background: #ffebee;
        border-left: 4px solid #f44336;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        display: none;
    }
    .error-message.show {
        display: block;
    }
    .success-message {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        display: none;
    }
    .success-message.show {
        display: block;
    }
    .warning-box {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        display: none;
    }
    .warning-box.show {
        display: block;
    }
    .btn-lg {
        padding: 12px 30px;
        font-size: 16px;
    }
    .spinner {
        display: none;
        margin-left: 10px;
    }
    .spinner.show {
        display: inline-block;
    }
    .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
        margin: 5px 0;
    }
    .status-checked-in {
        background: #4caf50;
        color: white;
    }
    .status-pending {
        background: #ffb74d;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="checkin-container">
    <div class="checkin-form">
        <h2>{% block page_title %}Device Check-In{% endblock %}</h2>
        <p class="text-muted">{% block page_description %}Scan or enter device asset tag to check in a device{% endblock %}</p>
        
        <!-- Error Message -->
        <div class="error-message" id="errorMessage">
            <strong>Error:</strong> <span id="errorText"></span>
        </div>
        
        <!-- Warning Message (Re-check-in) -->
        <div class="warning-box" id="warningBox">
            <strong>Warning:</strong> <span id="warningText"></span>
            <div style="margin-top: 10px;">
                <label class="form-check">
                    <input type="checkbox" class="form-check-input" id="confirmRecheck">
                    <span class="form-check-label">Confirm re-check-in</span>
                </label>
                <button class="btn btn-warning btn-sm" onclick="submitWithConfirmation()">
                    Re-Check-In Confirmed
                </button>
            </div>
        </div>
        
        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            <strong>✓ Success:</strong> <span id="successText"></span>
        </div>
        
        <!-- Device Details -->
        <div class="device-details" id="deviceDetails">
            <h5>Device Details</h5>
            <table class="table table-sm">
                <tr>
                    <td><strong>Asset Tag:</strong></td>
                    <td id="detailAssetTag"></td>
                </tr>
                <tr>
                    <td><strong>Owner:</strong></td>
                    <td id="detailOwner"></td>
                </tr>
                <tr>
                    <td><strong>Type:</strong></td>
                    <td id="detailType"></td>
                </tr>
            </table>
        </div>
        
        <!-- Student Info -->
        <div id="studentInfo" style="display: none;">
            <h5>Student Information</h5>
            <table class="table table-sm">
                <tr>
                    <td><strong>Name:</strong></td>
                    <td id="studentName"></td>
                </tr>
                <tr>
                    <td><strong>Grade:</strong></td>
                    <td id="studentGrade"></td>
                </tr>
                <tr>
                    <td><strong>Advisor:</strong></td>
                    <td id="studentAdvisor"></td>
                </tr>
                <tr>
                    <td><strong>Status:</strong></td>
                    <td id="studentStatus"></td>
                </tr>
            </table>
        </div>
        
        <!-- Form -->
        <form id="checkinForm" method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                {{ form.asset_tag }}
                {% if form.asset_tag.errors %}
                    <small class="form-text text-danger">{{ form.asset_tag.errors }}</small>
                {% endif %}
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg btn-block">
                Check In Device
                <span class="spinner" id="spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
            </button>
        </form>
        
        <!-- Instructions -->
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
            <h6>Instructions:</h6>
            <ol>
                <li>Hold barcode scanner near the device or enter asset tag manually</li>
                <li>Press <code>Enter</code> or click <strong>Check In Device</strong></li>
                <li>Confirm the student name and device details</li>
                <li>Student status will be marked as "checked in"</li>
            </ol>
        </div>
    </div>
</div>

<script>
document.getElementById('checkinForm').addEventListener('submit', function(e) {
    e.preventDefault();
    submitCheckIn();
});

function submitCheckIn() {
    const assetTag = document.getElementById('id_asset_tag').value.trim();
    const confirmRecheck = document.getElementById('confirmRecheck').checked;
    
    if (!assetTag) {
        showError('Asset tag cannot be empty');
        return;
    }
    
    // Show spinner
    document.getElementById('spinner').classList.add('show');
    
    // Send to API endpoint
    fetch('/devices/api/check-in', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            asset_tag: assetTag,
            confirm_recheck: confirmRecheck
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('spinner').classList.remove('show');
        
        if (data.success) {
            // Success
            showSuccess(data.message);
            showDeviceDetails(data.device_info);
            if (data.student_info) {
                showStudentInfo(data.student_info);
            }
            document.getElementById('checkinForm').reset();
            document.getElementById('confirmRecheck').checked = false;
        } else if (data.recheck_warning) {
            // Re-check-in warning
            showWarning(data.message);
            showDeviceDetails(data.device_info);
            showStudentInfo(data.student_info);
        } else {
            // Error
            showError(data.error || 'Check-in failed');
            if (data.device_info) {
                showDeviceDetails(data.device_info);
            }
            if (data.student_info) {
                showStudentInfo(data.student_info);
            }
        }
    })
    .catch(error => {
        document.getElementById('spinner').classList.remove('show');
        console.error('Error:', error);
        showError('Network error: ' + error.message);
    });
}

function submitWithConfirmation() {
    document.getElementById('confirmRecheck').checked = true;
    submitCheckIn();
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').classList.add('show');
    document.getElementById('warningBox').classList.remove('show');
    document.getElementById('successMessage').classList.remove('show');
}

function showWarning(message) {
    document.getElementById('warningText').textContent = message;
    document.getElementById('warningBox').classList.add('show');
    document.getElementById('errorMessage').classList.remove('show');
    document.getElementById('successMessage').classList.remove('show');
}

function showSuccess(message) {
    document.getElementById('successText').textContent = message;
    document.getElementById('successMessage').classList.add('show');
    document.getElementById('errorMessage').classList.remove('show');
    document.getElementById('warningBox').classList.remove('show');
}

function showDeviceDetails(info) {
    if (info) {
        document.getElementById('detailAssetTag').textContent = info.asset_tag || '—';
        document.getElementById('detailOwner').textContent = info.owner || 'Unknown';
        document.getElementById('detailType').textContent = info.cf_device_type || 'Unknown';
        document.getElementById('deviceDetails').classList.add('show');
    }
}

function showStudentInfo(info) {
    if (info) {
        document.getElementById('studentName').textContent = info.full_name || '—';
        document.getElementById('studentGrade').textContent = info.grade || '—';
        document.getElementById('studentAdvisor').textContent = info.advisor || '—';
        const status = info.device_checked_in ? 
            '<span class="status-badge status-checked-in">✓ Checked In</span>' :
            '<span class="status-badge status-pending">Pending</span>';
        document.getElementById('studentStatus').innerHTML = status;
        document.getElementById('studentInfo').style.display = 'block';
    }
}

// Auto-focus on asset tag input when page loads
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('id_asset_tag').focus();
});
</script>
{% endblock %}
